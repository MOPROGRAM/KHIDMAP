rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read any profile, but can only write to their own.
    match /users/{userId} {
      allow read;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can read any rating, but can only create ratings for others.
    match /ratings/{ratingId} {
      allow read;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.raterUserId;
    }
    
    // Rules for the top-level messages collection (the chat rooms)
    match /messages/{chatId} {
      // Allow a user to read, update, or delete a chat document if they are a participant.
      allow read, update, delete: if request.auth != null && request.auth.uid in resource.data.participants;
      // Allow a user to create a new chat if they are one of the participants in the new document.
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;

      // Rules for the nested "messages" subcollection within each chat
      match /messages/{messageId} {
        // A user can read or create a message if they are a participant in that message document.
        // This relies on the 'participants' array being stored in each message.
        allow read, create: if request.auth != null && request.auth.uid in resource.data.participants;
      }
    }
  }
}