
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own profile
    match /users/{userId} {
      allow read;
      allow write: if request.auth.uid == userId;
    }

    // Providers can be read by anyone
    match /users/{providerId} {
      allow read: if resource.data.role == 'provider';
    }

    // Ratings can be read by anyone, but only created by authenticated users
    match /ratings/{ratingId} {
      allow read;
      allow create: if request.auth != null;
    }
    
    // --- Messaging Rules ---
    match /messages/{chatId} {
      // Allow read/write only if the requesting user is a participant in the chat
      allow read, update, delete: if request.auth.uid in resource.data.participants;
      allow create: if request.auth.uid in request.resource.data.participants;
      
      match /messages/{messageId} {
        // Allow read if the user is a participant.
        // This rule works for queries because it reads from the document being requested (`resource.data`).
        allow read: if request.auth.uid in resource.data.participants;
        
        // On create, ensure the user is a participant AND the message is valid.
        allow create: if request.auth.uid in request.resource.data.participants
                      && request.resource.data.type in ['text', 'audio'];
      }
    }
  }
}
